---
title: "TVprogram"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)



drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv,dbname="video",host="192.168.11.52",port=5431,
                 user="b4" ,password="takayuki")
```


```{r get_data}
pro <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "tv_program")) 
sta <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "sta_mst"))
ban <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "bancluster_mst"))
sintoku <- con %>% 
  tbl(from = dbplyr::in_schema("sub_mst", "sin_toku_mst"))
form <- con %>% 
  tbl(from = dbplyr::in_schema("sub_mst", "br_format_mst"))
week <- con %>% 
  tbl(from = dbplyr::in_schema("sub_mst", "day_week_mst"))
```


#番組情報
***
|番組情報   |_data     |データ型   |主キー|外部キーNo.|種目数|最小値|最大値|
|---------------|---------------|-----------|------|-----------|------|------|------|
|局コード         |station_code       |int        |PK    |FK4      | 7 | 1 | 7 |
|番組コード       |program_code       |char        |PK    |         | 707 | 4 | 4 |
|曜日コード       |program_day_week      |int        |      |FK14     | 7 | 1 | 7 |
|放送日	          |program_date       |date		    |PK    |         | 364 | 2017/4/3 |	2018/4/1 |
|開始時刻         |program_start_time |timestamp  |      |         | 68192 | 2017/4/3 5:00 | 2018/4/2 4:55 |
|放送分数         |program_time	      |int		    |      |         | 242 |	1	| 410 |
|終了時刻         |program_end_time   |timestamp  |      |         | 68236 | 2017/4/3 5:20 | 2018/4/2 5:00 |
|大分類コード     |ban_code1	        |int		    |      |FK10      | 8 |	1	| 8 |
|中分類コード     |ban_code2	        |int		    |      |FK11      | 16 |	1	| 16 |
|分類コード       |ban_code3	        |char		    |      |FK12      | 70 |	3	| 3 |
|新番・特番フラグ |sin_toku	          |char		    |      |FK19      | 2 |	1	| 1 |
|放送形式         |br_format	        |int		    |      |FK20      | 5 |	0	| 4 |
|最終回コード     |final_code	        |int  		  |      |          | 2	| 0	| 1 |
|番組名（漢字）   |program_name	      |char  		  |      |          | 8134	| 2	| 41 |
|番組名（カナ）   |program_name_kana  |char  		  |      |          | 3877	| 1	| 20 |

```{r 番組情報}
head(pro)
```

###局コード 外部キー4 局マスタ
|局マスタ       |sta_mst        |データ型   |主キー|外部キーNo.|
|---------------|---------------|-----------|------|-----------|
|局コード       |station_code   |int        |PK    |     |
|局名称	        |station_jp	    |char		    |      |     |
|局略称         |station_ab     |char       |      |     |


```{r count_station}

count_sta <- dbGetQuery(con,"
SELECT
	A.st_code,
	A.count,
	B.station_jp,
	B.station_ab
FROM
	processed.sta_mst AS B
LEFT JOIN
	(SELECT
		distinct(station_code) AS st_code,
		count(station_code) AS count
	FROM
		processed.tv_program 
	GROUP BY 
		station_code) AS A
ON
	A.st_code = B.station_code
ORDER BY
	A.st_code;
")

count_sta %>% 
  kable(caption = "station_code ごとのログ数")

barplot(count_sta$count, names.arg=count_sta$station_jp, ylim = c(0,30000))

```
  
単純な番組数はNHKが多い→番組分数と相関強そう？  


#曜日

```{r count_week}
count_week <- dbGetQuery(con,"
                          SELECT
                          	A.day,
                          	A.count,
                          	B.day_week_name
                          FROM
                          	sub_mst.day_week_mst AS B
                          LEFT JOIN
                          	(SELECT
                          		distinct(program_day_week) AS day,
                          		count(program_day_week) AS count
                          	FROM
                          		processed.tv_program 
                          	GROUP BY 
                          		program_day_week) AS A
                          ON
                          	A.day = B.day_week
                          ORDER BY
                          	A.day;")
count_week %>% 
  kable(caption = "曜日ごとのログ数")

barplot(count_week$count, names.arg=count_week$day_week_name)
```

#番組開始/終了時刻
## 基本統計量
```{r 番組開始時刻}
pro_start <- dbGetQuery(con,"
                           SELECT
                             program_start_time,
                             program_end_time
                           FROM 
                             processed.tv_program
                          group by
                             program_start_time,
                             program_end_time
                          ")

summary(pro_start) %>% 
  kable(caption = "曜日ごとのログ数")
#head(cm$cm_start_time)
#hist(cm$cm_start_time)
```


## 番組開始時間
```{r}
count_hourly <- dbGetQuery(con,"
                           SELECT
                             EXTRACT(HOUR FROM  program_start_time),
                             COUNT(*)
                           FROM 
                             processed.tv_program
                           GROUP BY
                             EXTRACT(HOUR FROM program_start_time)")

count_hourly  %>% 
  arrange(date_part) %>% 
  kable()

count_hourly %>% 
  as_tibble() %>% 
  rename(hour = date_part) %>% 
  ggplot(aes(hour, count))+
  geom_bar(stat = "identity")+
  labs(title = "時間帯ごとの番組本数")
```


#放送分数
##基本統計量
```{r 放送分数1}
time_count <- dbGetQuery(con,"
                           SELECT
                             distinct(program_time),
                             count(program_time)
                           FROM 
                             processed.tv_program
                          group by
                             program_time
                          ")

#time_count %>% 
#  kable()
summary(time_count$program_time)
```
    
放送分数は242種類.    

##放送分数プロット
```{r 放送分数2}
time_countP1 <-
  ggplot(time_count, aes(x = program_time, y = count))+
  geom_bar(stat = "identity")+
  labs(title = "放送分数（全体）")

time_countP2 <-
  ggplot(time_count, aes(x = program_time, y = count))+
  geom_bar(stat = "identity")+
  xlim(c(0, 61))+
  labs(title = "放送分数（60分まで）")

time_countP1
time_countP2

```
  


```{r 24jikan}

jikan_24 <- dbGetQuery(con,"
              SELECT
               *
              FROM 
               processed.tv_program
              where
               (station_code = 1
							 and
							 program_start_time >= TO_TIMESTAMP('2017/08/26 18:30:00', 'YYYY-MM-DD HH24:MI:SS')
              and
							 program_start_time <= TO_TIMESTAMP('2017/08/27 19:00:00', 'YYYY-MM-DD HH24:MI:SS')

               )
						 order by 
						 	 program_start_time; ")

jikan_24 %>% 
  kable()

jikan_max <- dbGetQuery(con,"
              SELECT
               *
              FROM 
               processed.tv_program
              where
							 program_time > 400
						 order by 
						 	 program_start_time; ")
jikan_max %>% 
  kable()

```
