---
title: "performer"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)


theme_set(theme_bw(base_family = "HiraKakuPro-W3"))

source("psql.R")

```

#内容確認
```{r head_performer, result = "asis"}
performer <- con %>% 
  tbl(from = dbplyr::in_schema("add_data", "performer")) 
data <- performer %>% 
  head(100) %>% 
  collect()

data %>% 
  datatable(style="bootstrap", class="table-condensed", options = list(dom = 'tp',scrollX = TRUE))

```


#カウント
##番組情報ベース
  
5局分でチェック

```{r add data の件数}
count0 <- dbGetQuery(con,"
SELECT
	*
FROM
	processed.tv_program as T
LEFT JOIN
	(SELECT
		*
	FROM
	 	add_data.performer_tmp3
	WHERE
		(br_start_datetime_crow >= '20170403050000'
	 AND
		br_start_datetime_crow <= '20180402045900')
	) as A
ON
	(A.station_code = T.station_code
	AND
	A.br_start_datetime_crow <= T.program_start_time
	AND
	A.br_end_datetime_crow > T.program_start_time)
WHERE
	T.station_code <= 5
LIMIT 10;")

count0 %>%
  kable()

```
  
局ごとにカウントした．58812行全て！

```{r}
count1 <- dbGetQuery(con,"
SELECT
	distinct(T.station_code),
	count(T.station_code)
FROM
	processed.tv_program as T
LEFT JOIN
	(SELECT
		*
	FROM
	 	add_data.performer_tmp3
	WHERE
		br_start_datetime_crow >= '20170403050000'
	 AND
		br_start_datetime_crow <= '20180402045900'
	) as A
ON
	(A.station_code = T.station_code
	AND
	A.br_start_datetime_crow <= T.program_start_time
	AND
	A.br_end_datetime_crow > T.program_start_time)
WHERE
	T.station_code <= 5
GROUP BY
	T.station_code;
")


count1 %>%
  kable()

```
  

##出演者ベース
  
tv_programよりも期間が長いので, それを抜いたもののカウント, 局ごとのカウントを行う.  

```{r monthly1}
count2 <- dbGetQuery(con,"
SELECT
	A.station_jp,
	P.station_jp_crow,
	A.station_code,
	A.program_day_week,
	A.program_start_time,
	P.br_start_datetime_crow,
	A.program_name,
	P.program_name_crow,
	P.station_jp_crow
FROM
	add_data.performer as P
LEFT JOIN
	(SELECT
		station_jp,
		T.*		
	FROM
	 	processed.tv_program as T
	LEFT JOIN
	 	processed.sta_mst as M
	 ON
	 	M.station_code = T.station_code
	WHERE
		T.station_code <= 5 
	) as A
ON
	A.station_jp = P.station_jp_crow 
	AND
	A.program_start_time = P.br_start_datetime_crow 
WHERE
		P.br_start_datetime_crow >= '20170403050000'
	 AND
		P.br_start_datetime_crow <= '20180402045900'
	limit  10;
                           ")

count2 %>%
  kable()
```
  
局ごとにカウントした．結果一致しなかった行は1006行.

```{r}
count3 <- dbGetQuery(con,"
SELECT
	distinct(station_jp),
	count(station_jp)
FROM
	add_data.performer as P
LEFT JOIN
	(SELECT
		station_jp,
		T.*		
	FROM
	 	processed.tv_program as T
	LEFT JOIN
	 	processed.sta_mst as M
	 ON
	 	M.station_code = T.station_code
	WHERE
		T.station_code <= 5 
	) as A
ON
	A.station_jp = P.station_jp_crow 
	AND
	A.program_start_time = P.br_start_datetime_crow 
WHERE
		P.br_start_datetime_crow >= '20170403050000'
	 AND
		P.br_start_datetime_crow <= '20180402045900'
GROUP BY
	station_jp;                           ")

count3 %>%
  kable()
```





