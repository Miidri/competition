---
title: "cluster"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT","gridExtra","fmsb","corrplot","graphics","GGally") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)

source("/home/miidri/competition/psql.R")
```

#アンケとは別に追加された質問
- 性別
- 年齢（10代～70代以上）
- 未既婚
- 職業
    - IT・通信・インターネット 
    - メーカー
    - 商社
    - サービス・レジャー
    - 流通・小売・フード
    - マスコミ
    - 広告・デザイン
    - 金融・保険
    - コンサルティング
    - 不動産・建設・設備
    - 運輸・交通・物流・倉庫
    - 環境・エネルギー
    - 公的機関・その他
    - 学生
    - 主婦・無職


# data1, data, data2
##data1 アンケート長いやつ
```{r data1 アンケート長いやつ}
data1 <- dbGetQuery(con,"
SELECT
  house_num,
  question_code,
  answer_code
FROM
	processed.profiledata
WHERE
	qu_genre_code = 3
	and
	question_code >= 4 
	and
	question_code <= 21
ORDER BY
  house_num,
	question_code,
	answer_code
;")

head(data1) %>%
  kable
```

```{r data アンケート行列}
data1 <- data1 %>%
  tidyr::spread(key = question_code, value = answer_code)

head(data1)%>%
  kable()
```

## data2 アンケート標本情報
```{r data2 アンケート標本情報}
data2 <-dbGetQuery(con,"
SELECT
  distinct(P.house_num),
  S.sex,
  S.marriage,
  S.age
FROM
	processed.profiledata as P
LEFT JOIN
	(SELECT
    house_num,
    sample_date,
    age,
    sex,
    marriage
  FROM
    processed.tv_sample_p_cv
  WHERE
    (house_num, sample_date)
  IN
  (
      SELECT
        house_num,
        min(sample_date) as sample_date
      FROM
        processed.tv_sample_p_cv
      GROUP BY
        house_num
  )) as S
ON
	S.house_num = P.house_num
WHERE
	P.qu_genre_code = 3
	and
	P.question_code >= 4 
	and
	P.question_code <= 21
GROUP BY
	P.house_num,
	S.sex,
	S.marriage,
	S.age,
  P.question_code,
  P.answer_code
ORDER BY
	house_num;")

# 黒木さんの力技バージョン
if(0){
sample <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "tv_sample_p_cv"))
prof_data <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "profiledata"))
prof_mst <- con %>% 
  tbl(from = dbplyr::in_schema("processed", "profilemaster"))
prof <- prof_data %>% 
  left_join(prof_mst, by = c("qu_genre_code", "question_code", "answer_code"))
 
data5 <- sample %>% 
  group_by(house_num) %>%
  filter(sample_date == min(sample_date)) %>% 
  right_join(prof %>% 
               filter(qu_genre_code == 3,
                      question_code <= 21,
                      question_code >= 4),
             by = "house_num") %>% 
  collect()
dim(data5)
head(data5)%>%
  kable()
}

head(data2)%>%
  kable()
```

## data dataとdata2をくっつけた
  
繋げてから, 標本情報のNAがある行も消去.  
```{r data dataとdata2をくっつけた}
data <- merge(data1, data2, by = "house_num")
head(data)%>%
  kable()

table(is.na(data))
data[!complete.cases(data),]

data <- data[c(-1053,-4400,-4698),]

table(is.na(data))
dim(data)
```

# 情報セグメントの回答行列
## アンケート内容
4	良いと思った情報はできるだけ多くの人と共有することが多い  
5	周りの人が持っているモノなどを見て思わず自分も欲しくなってしまうことが多い  
6	どうしても必要なもの以外、買わないほうだ  
7	情報は人より早く知っていることが多い  
8	情報は広く浅く知っていれば十分だと思う  
9	口コミ情報を参考にすることが多い  
10	周りのみんなが持っているモノを自分だけ持っていないと不安に感じる  
11	流行に左右されない、長年使い続けられるものを選ぶことが多い  
12	情報収集に時間をかけるのはもったいない  
13	買い物をすること自体が楽しく、好きだ  
14	趣味や興味関心ごとなどのうんちくはたくさん持っている  
15	面白いと思った情報は周りの人に話したくなる  
16	情報収集は自ら積極的に行うほうだ  
17	「限定モノ」や「流行モノ」に弱く、すぐ欲しくなる  
18	最低限の情報を持っていれば十分だ  
19	周りの人がみんな買っているならその商品は間違いなく良いモノだと思う  
20	一流・有名ブランド、メーカーの商品を買うのが好きだ（衣料品、バッグ、時計など）  
21	丈夫で長持ちするモノを選ぶことが多い  


# 主成分分析
  
分析対象はdata1, すなわち, 標本情報抜きのやつ
```{r dataに主成分}
data1.pca <- prcomp(data1[,-1], scale=T)
data1.pca

biplot(data1.pca)
summary(data1.pca)
# Proportion of Variance:寄与率
# Cumulative Proportion:累積寄与率
#data.frame(unclass(summary(data.pca)), check.names = FALSE, stringsAsFactors = FALSE)
# 寄与率プロットしたいのに！できない！
#pca <- ggplot(data.pcaS, aes(data.pcaS))+ 
#  geom_histogram()

```

# k-means法  
  
最終的に6クラスタに分けたいから $k = 6$ でやってみる.

```{r}
data1.km <- kmeans(data1[,-1],6)
#data1.km

data1.pca.df <- data.frame(data1.pca$x)
data1.pca.df$house_num <- data1$house_num
data1.pca.df$answer_code <- as.factor(data1.km$cluster)
#head(data1.pca.df) %>%
#  kable()
P1 <-
  ggplot(data1.pca.df, aes(x=PC1, y= PC2, label = house_num, col = answer_code ))+
  geom_text()

P1
```
  
標本情報試しに入れたやつの100倍マシ, still worse

# アンケート内容を分けてみた
##情報
* ＋  
4	良いと思った情報はできるだけ多くの人と共有することが多い  
7	情報は人より早く知っていることが多い  
9	口コミ情報を参考にすることが多い  
14	趣味や興味関心ごとなどのうんちくはたくさん持っている  
15	面白いと思った情報は周りの人に話したくなる  
16	情報収集は自ら積極的に行うほうだ 
  
* －  
8	情報は広く浅く知っていれば十分だと思う  
12	情報収集に時間をかけるのはもったいない  
18	最低限の情報を持っていれば十分だ 


##購買行動
* ＋ 
13	買い物をすること自体が楽しく、好きだ  
17	「限定モノ」や「流行モノ」に弱く、すぐ欲しくなる  
20	一流・有名ブランド、メーカーの商品を買うのが好きだ（衣料品、バッグ、時計など）  

* △  
5	周りの人が持っているモノなどを見て思わず自分も欲しくなってしまうことが多い  
10	周りのみんなが持っているモノを自分だけ持っていないと不安に感じる  
19	周りの人がみんな買っているならその商品は間違いなく良いモノだと思う  
  
* －  
6	どうしても必要なもの以外、買わないほうだ  
11	流行に左右されない、長年使い続けられるものを選ぶことが多い  
21	丈夫で長持ちするモノを選ぶことが多い 
  


## 情報サンプル

500人の情報収集についての質問の行列作ってみた. 標本情報も足す. 500*10 
```{r 情報1}
data31 <- data.frame(house_num=data1$house_num, Q12=data1$`12`, Q18=data1$`18`, Q8=data1$`8`, Q9=data1$`9`,Q4=data1$`4`, Q7=data1$`7`, Q14=data1$`14`, Q15=data1$`15`, Q16=data1$`16`)
data31 <- data31[-501:-4715,]
#dim(data31)
head(data31)%>%
  kable()
# 散布図行列
corrplot::corrplot(cor(data31[,-1]))

ggpairs(
	data31[,-1],
	lower = list(continuous = "facetbar", combo = "box"))
```

### やってみた
  
```{r 31}
#分散共分散行列
var(data31[,-1])
#固有値･固有ベクトル
eigen(var(scale(data31[,-1])))

data31.pca <- prcomp(data31[,-1], scale=T)
data31.pca
summary(data31.pca)
biplot(data31.pca)

data31.km <- kmeans(data31[,-1],4)
#data3.km
data31.pca.df <- data.frame(data31.pca$x)
data31.pca.df$house_num <- data31$house_num
data31.pca.df$answer_code <- as.factor(data31.km$cluster)
head(data31.pca.df)
P31 <-
  ggplot(data31.pca.df, aes(x=PC1, y= PC2, label = house_num, col = answer_code ))+
  geom_text()

P31
```


## 購買サンプル
* +  
5	周りの人が持っているモノなどを見て思わず自分も欲しくなってしまうことが多い  
10	周りのみんなが持っているモノを自分だけ持っていないと不安に感じる  
17	「限定モノ」や「流行モノ」に弱く、すぐ欲しくなる  
  
* △  
19	周りの人がみんな買っているならその商品は間違いなく良いモノだと思う  
13	買い物をすること自体が楽しく、好きだ  
20  一流・有名ブランド、メーカーの商品を買うのが好きだ（衣料品、バッグ、時計など）

* －  
6	どうしても必要なもの以外、買わないほうだ  
11	流行に左右されない、長年使い続けられるものを選ぶことが多い  
21	丈夫で長持ちするモノを選ぶことが多い 


500人の購買嗜好についての質問の行列作ってみた. 500*10
```{r 購買1}
data32 <- data.frame(house_num=data1$house_num, Q6=data1$`6`, Q11=data1$`11`, Q21=data1$`21`, Q5=data1$`5`, Q10=data1$`10`, Q19=data1$`19`, Q13=data1$`13`, Q17=data1$`17`, Q20=data1$`20`)
data32 <- data32[-501:-4715,]
head(data32)%>%
  kable()
# 散布図行列
corrplot::corrplot(cor(data32[,-1]))

ggpairs(data32[,-1],aes_string(alpha=0.5), color = "smoker")


ggpairs(
	data32[,-1],
	lower = list(continuous = "facetbar", combo = "box"))


ggpairs(
	data32[,-1],
	lower = list(continuous = "density", combo = "box"),
	color = "smoker"
	)
```

### やってみた

```{r 32}
#分散共分散行列
var(data32[,-1])
#固有値･固有ベクトル
eigen(var(scale(data32[,-1])))

data32.pca <- prcomp(data32[,-1], scale=T)
data32.pca
summary(data32.pca)
biplot(data32.pca)

data32.km <- kmeans(data32[,-1],3)
#data3.km
data32.pca.df <- data.frame(data32.pca$x)
data32.pca.df$house_num <- data32$house_num
data32.pca.df$answer_code <- as.factor(data32.km$cluster)
head(data32.pca.df)
P32 <-
  ggplot(data32.pca.df, aes(x=PC1, y= PC2, label = house_num, col = answer_code ))+
  geom_text()

P32
```

```{r 34}
#分散共分散行列
var(data32[,-1])
#固有値･固有ベクトル
eigen(var(scale(data32[,-1])))

data32.pca <- prcomp(data32[,-1], scale=T)
data32.pca
summary(data32.pca)
biplot(data32.pca)

```

