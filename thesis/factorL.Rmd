---
title: "factorL"
author: "Midori Omura"
editor_options: 
  chunk_output_type: console
---
title: "因子分析 facter analysis"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT","gridExtra","fmsb","corrplot","graphics","GGally","psych", "GPArotation") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)

source("/home/miidri/competition/psql.R")
source("/home/miidri/competition/data_name.R")
```

# 表現嗜好
***
- L1  シリーズもののCMや広告は続きが気になる
- L2  ドラマ（物語）仕立ての表現をしているCMが好き
- L3  シリーズもののCMや広告に注目してしまうことが多い
- L4  好きなタレントを起用しているCMや広告の商品は試してみたくなる
- L5  好きなタレントを起用しているCMや広告に注目してしまうことが多い
- L6  自分の好きな楽曲を使っている企業には好感を持つことが多い
- L7  自分のライフスタイルに合った内容のCMや広告は注目してしまうことが多い
- L8  好きなタレントを起用している企業には好感を持つことが多い
- L9  細かに作りこんだ映像（画像）は見入ってしまうことが多い
- L10 きれいな女性が登場するCMに注目してしまうことが多い
- L11 キャラクターを用いたCMや広告は親しみを感じるものが多い
- L12   美しい風景や大自然の映像をつかったCMに注目してしまうことが多い
- L13  子供や動物が登場するCMに注目してしまうことが多い
- L14  目や耳にとまるフレーズ（コピー）があると印象に残っていることが多い
- L15 説明的なCMや広告よりも「何これ？」と思えるCMや広告の方が好き
- L16 理屈よりも印象的な映像（画像）や音楽などで感性に訴えてくるCMや広告が好き
- L17 商品そのものよりも、世界観をイメージできるような表現のCMや広告が好き
- L18 商品の特徴（効用）を実際に見せているCMや広告は信用できる
- L19 自社商品を他社商品と比較したCMや広告はわかりやすくてよい
- L20 タレントよりも一般人の感想の方が信頼感がある
- L21 間接的なイメージのCMや広告よりもきちんと説明されている方がよい
- L22 実際の利用者の声には説得力があると思う
- L23 過度に作りこんだ映像（画像）には説得力を感じない
- L24 商品の特徴や性能を実験データで示しているCMや広告は信用できる
- L25 商品について必要最小限の説明でシンプルなCMや広告が好き
- L26 意味のないインパクトだけのCMや広告は信用性に欠けると思う
- L27 専門家が紹介している商品は信用性が高いと思う
- L28 社会風刺やブラックユーモアをまじえたものがもっとあってもよいと思う
- L29 お笑い、ユーモアをまじえたものがもっとあってもよいと思う
- L30 商品を売ろうという意図を感じると商品自体を敬遠してしまう





## 相関行列
```{r dataL 相関行列}
#相関行列の作成
dataL.c <- cor(dataL1[,-1])

dataL.c %>% 
  kable()
```
  
## 固有値
```{r dataI1 固有値}
eigenL1 <- eigen(dataL.c)$values
# 固有値
eigenL1 
```

## 因子数決定
```{r dataI1 plot}
# Minimum Average Partial, BIC
VSS(dataL1[-1], n=10)
# 平行分析
fa.parallel(dataL1[,-1])
```
  
- MAP:4  
- BIC:9  
- PC:5  
- FA:8  
第4固有値までで行ってみる.

# 因子分析
***
データ数が多いため, 最尤法を用いる.  
また心理尺度であるため, 斜交回転 (promax)を行う.  

```{r promax}
mlL	<-	fa(r=dataL1[,-1],	nfactors=4,	rotate="promax",	fm="ml")
print(mlL)
par(mfrow=c(1,2)) 
barplot(mlL$loadings[,1]) 
barplot(mlL$loadings[,2]) 
barplot(mlL$loadings[,3]) 
barplot(mlL$loadings[,4]) 
plot(mlL$loadings, type="n")
text(mlL$loadings) 
```

```{r biplot}
biplot(mlL$scores[,c(1,2)], mlL$loadings)
biplot(mlL$scores[,c(1,3)], mlL$loadings)
biplot(mlL$scores[,c(1,4)], mlL$loadings)
biplot(mlL$scores[,c(2,3)], mlL$loadings)
biplot(mlL$scores[,c(2,4)], mlL$loadings)
biplot(mlL$scores[,c(3,4)], mlL$loadings)
```

```{r}

scores <- mlL$scores
fa1 <- scores[,1]
fa2 <- scores[,2]
fa3 <- scores[,3]

# Loadings
loads <- mlL$loadings

# Scale factor for loadings
scale.loads <- 30

# 3D plot
library(plotly)
p <- plot_ly() %>%
  add_trace(x=fa1, y=fa2, z=fa3, name="",
            type="scatter3d", mode="markers",
            marker = list(#color=y,
              size = 1,
               # colorscale = c("#FFE1A1", "#683531"), 
               opacity = 0.7)) 

for (k in 1:nrow(loads)) {
   fa1 <- c(0, loads[k,1])*scale.loads
   fa2 <- c(0, loads[k,2])*scale.loads
   fa3 <- c(0, loads[k,3])*scale.loads
   p <- p %>% add_trace(x=fa1, y=fa2, z=fa3,
                        name = rownames(loads)[k],
            type="scatter3d", mode="lines",
            line = list(width=8),
            opacity = 1)
}
print(p)



```

```{r dist}
dEL <- proxy::dist(mlL$scores, method="Euclidean")
head(dEL)
dEL1 <- as.matrix(dEL)
#write.csv(dEI1, file= "/home/miidri/competition/dEI1.csv")
rownames(dEL1) <- dataL$house_num
colnames(dEL1) <- dataL$house_num
dEL1[1:5,1:5]
```