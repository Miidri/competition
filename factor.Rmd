---
title: "cluster"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT","gridExtra","fmsb","corrplot","graphics","GGally","psych", "GPArotation") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)

source("/home/miidri/competition/psql.R")
```


# data
## data作成
  詳しくはcluster.rmdをチェック  
```{r data1 アンケート長いやつ}
data1 <- dbGetQuery(con,"
SELECT
  house_num,
  question_code,
  answer_code
FROM
	processed.profiledata
WHERE
	qu_genre_code = 3
	and
	question_code >= 4 
	and
	question_code <= 21
ORDER BY
  house_num,
	question_code,
	answer_code
;")

```

```{r data アンケート行列}
data1 <- data1 %>%
  tidyr::spread(key = question_code, value = answer_code)

```

```{r data2 アンケート標本情報}
data2 <-dbGetQuery(con,"
SELECT
  distinct(P.house_num),
  S.sex,
  S.marriage,
  S.age
FROM
	processed.profiledata as P
LEFT JOIN
	(SELECT
    house_num,
    sample_date,
    age,
    sex,
    marriage
  FROM
    processed.tv_sample_p_cv
  WHERE
    (house_num, sample_date)
  IN
  (
      SELECT
        house_num,
        min(sample_date) as sample_date
      FROM
        processed.tv_sample_p_cv
      GROUP BY
        house_num
  )) as S
ON
	S.house_num = P.house_num
WHERE
	P.qu_genre_code = 3
	and
	P.question_code >= 4 
	and
	P.question_code <= 21
GROUP BY
	P.house_num,
	S.sex,
	S.marriage,
	S.age,
  P.question_code,
  P.answer_code
ORDER BY
	house_num;")
```

```{r data dataとdata2をくっつけてNAもやっつけた}
data <- merge(data1, data2, by = "house_num")
#table(is.na(data))
data[!complete.cases(data),]
data <- data[c(-1053,-4400,-4698),]
#table(is.na(data))
#dim(data)
```

***
# data分離{.tabset .tabset-fade .tabset-pills}
***

## data全容

```{r}
head(data) %>% 
  kable()
```

## 男性既婚MM
```{r}
data_M <- subset(data, sex==1)
data_MM<- subset(data_M, marriage==2)

head(data_MM) %>% 
  kable()
```

## 男性未婚MU

```{r}
data_MU<- subset(data_M, marriage==1)

head(data_MU) %>% 
  kable()
```

## 女性既婚FM

```{r}
data_F <- subset(data, sex==2)
data_FM<- subset(data_F, marriage==2)

head(data_FM) %>% 
  kable()
```

## 女性未婚FU

```{r}
data_FU<- subset(data_F, marriage==1)

head(data_FU) %>% 
  kable()
```

## 年齢を10歳刻みにした度数分布

```{r}
age_freq10 <- cut(data$age, breaks=seq(10,70,10))
age_tab10 <- table(age_freq10)
age_tab10 <- data.frame(age_tab10)
ageX <-c("11-20","21-30","31-40","41-50","51-60","61-70")
age_tab10 <- cbind(age = ageX, count = age_tab10$Freq )
age_tab10 %>% 
  kable()
```


## クロス分析 of 性別・未既婚
  
男性1, 女性2：既婚1, 未婚2  
```{r}
# クロス分析的な抜き出し
# 1718は男性既婚
sex_marriage <- table(data$sex, data$marriage)
# 命名は暇なとき調べよう
sexN <- c("男性", "女性")
marriageN  <- c("既婚", "未婚")

sex_marriage%>% 
  kable()
mosaicplot(sex_marriage,shad=TRUE)

```

***
# 情報セグメントの回答行列
***

## アンケート内容
4	良いと思った情報はできるだけ多くの人と共有することが多い  
5	周りの人が持っているモノなどを見て思わず自分も欲しくなってしまうことが多い  
6	どうしても必要なもの以外、買わないほうだ  
7	情報は人より早く知っていることが多い  
8	情報は広く浅く知っていれば十分だと思う  
9	口コミ情報を参考にすることが多い  
10	周りのみんなが持っているモノを自分だけ持っていないと不安に感じる  
11	流行に左右されない、長年使い続けられるものを選ぶことが多い  
12	情報収集に時間をかけるのはもったいない  
13	買い物をすること自体が楽しく、好きだ  
14	趣味や興味関心ごとなどのうんちくはたくさん持っている  
15	面白いと思った情報は周りの人に話したくなる  
16	情報収集は自ら積極的に行うほうだ  
17	「限定モノ」や「流行モノ」に弱く、すぐ欲しくなる  
18	最低限の情報を持っていれば十分だ  
19	周りの人がみんな買っているならその商品は間違いなく良いモノだと思う  
20	一流・有名ブランド、メーカーの商品を買うのが好きだ（衣料品、バッグ、時計など）  
21	丈夫で長持ちするモノを選ぶことが多い  

***
# 因子分析 data1{.tabset .tabset-fade .tabset-pills}
***

## data
```{r data因子分析}
#相関行列の作成
data1.c <- cor(data1[,-1])
#head(data1.c)
eigen1 <- eigen(data1.c)$values
# 固有値
eigen1 %>% 
  kable()
```

```{r data summary}
data1S <- data.frame(unclass(summary(data1.c)), check.names = FALSE, stringsAsFactors = FALSE)
data1S %>% 
  kable()
```

```{r data plot}
P_1 <- plot(eigen1, type = "b", main = "all")
```
  
これなら第4固有値でよさげ？

```{r 因子分析1}
F1 <- factanal(x=data1,	factors=3,	rotation="none")
print(F1,	cutoff=0)

F2	<-	factanal(x=data1,	factors=3,	rotation="varimax")
print(F2,	cutoff=0)

F3	<-	factanal(x=data1,	factors=3,	rotation="promax")
print(F3,	cutoff=0)
```

```{r 因子分析2}
fit11	<-	fa(r=data,	nfactors=2,	rotate="varimax",	fm="ml")
print(fit11)

fit12	<-	fa(r=data,	nfactors=2,	rotate="promax",	fm="ml")
print(fit12)
```

## data_MM
```{r MM因子分析}
#相関行列の作成
#dim(data_MM)
data_MM <- data_MM[,c(-20:-22)]
dataMM.c <- cor(data_MM[,-1])
#dataMM.c
eigenMM <- eigen(dataMM.c)$values
# 固有値
eigenMM %>% 
  kable()
```

```{r MMsummary}
dataMMS <- data.frame(unclass(summary(dataMM.c)), check.names = FALSE, stringsAsFactors = FALSE)
dataMMS %>% 
  kable()
```

```{r MMplot}
P_MM <- plot(eigenMM, type = "b", main = "既婚男性")
```

```{r MM因子分析1}
FMM1 <- factanal(x=data_MM,	factors=3,	rotation="none")
print(FMM1,	cutoff=0)

FMM2	<-	factanal(x=data_MM,	factors=3,	rotation="varimax")
print(FMM2,	cutoff=0)

FMM3	<-	factanal(x=data_MM,	factors=3,	rotation="promax")
print(FMM3,	cutoff=0)
```

```{r MM因子分析2}
fitMM1	<-	fa(r=data_MM,	nfactors=2,	rotate="varimax",	fm="ml")
print(fitMM1)

fitMM2	<-	fa(r=data_MM,	nfactors=2,	rotate="promax",	fm="ml")
print(fitMM2)
```

## data_MU
```{r MU因子分析}
#相関行列の作成
#dim(data_MU)
data_MU <- data_MU[,c(-20:-22)]
dataMU.c <- cor(data_MU[,-1])
#dataMU.c
eigenMU <- eigen(dataMU.c)$values
# 固有値
eigenMU %>% 
  kable()
```

```{r MUsummary}
dataMUS <- data.frame(unclass(summary(dataMU.c)), check.names = FALSE, stringsAsFactors = FALSE)
dataMUS %>% 
  kable()
```

```{r MUplot}
P_MU <- plot(eigenMU, type = "b", main = "未婚男性")
```
  
```{r MU因子分析1}
FMU1 <- factanal(x=data_MU,	factors=3,	rotation="none")
print(FMU1,	cutoff=0)

FMU2	<-	factanal(x=data_MU,	factors=3,	rotation="varimax")
print(FMU2,	cutoff=0)

FMU3	<-	factanal(x=data_MU,	factors=3,	rotation="promax")
print(FMU3,	cutoff=0)
```

```{r MU因子分析2}
fitMU1	<-	fa(r=data_MU,	nfactors=2,	rotate="varimax",	fm="ml")
print(fitMU1)

fitMU2	<-	fa(r=data_MU,	nfactors=2,	rotate="promax",	fm="ml")
print(fitMU2)
```

## data_FM
```{r FM因子分析}
#相関行列の作成
#dim(data_FM)
data_FM <- data_FM[,c(-20:-22)]
dataFM.c <- cor(data_FM[,-1])
#dataFM.c
eigenFM <- eigen(dataFM.c)$values
# 固有値
eigenFM %>% 
  kable()
```

```{r FMsummary}
dataFMS <- data.frame(unclass(summary(dataFM.c)), check.names = FALSE, stringsAsFactors = FALSE)
dataFMS %>% 
  kable()
```

```{r FMplot}
P_FM <- plot(eigenFM, type = "b", main = "既婚女性")
```
  
```{r FM因子分析1}
FFM1 <- factanal(x=data_FM,	factors=3,	rotation="none")
print(FFM1,	cutoff=0)

FFM2	<-	factanal(x=data_FM,	factors=3,	rotation="varimax")
print(FFM2,	cutoff=0)

FFM3	<-	factanal(x=data_FM,	factors=3,	rotation="promax")
print(FFM3,	cutoff=0)
```

```{r FM因子分析2}
fitFM1	<-	fa(r=data_FM,	nfactors=2,	rotate="varimax",	fm="ml")
print(fitFM1)

fitFM2	<-	fa(r=data_FM,	nfactors=2,	rotate="promax",	fm="ml")
print(fitFM2)
```

## data_FU
```{r FU因子分析}
#相関行列の作成
#dim(data_FU)
data_FU <- data_FU[,c(-20:-22)]
dataFU.c <- cor(data_FU[,-1])
#dataFU.c
eigenFU <- eigen(dataFU.c)$values
# 固有値
eigenFU %>% 
  kable()
```

```{r FUsummary}
dataFUS <- data.frame(unclass(summary(dataFU.c)), check.names = FALSE, stringsAsFactors = FALSE)
dataFUS %>% 
  kable()
```

```{r FUplot}
P_FU <- plot(eigenFU, type = "b", main = "未婚女性")
```
  
```{r FU因子分析1}
FFU1 <- factanal(x=data_FU,	factors=3,	rotation="none")
print(FFU1,	cutoff=0)

FFU2	<-	factanal(x=data_FU,	factors=3,	rotation="varimax")
print(FFU2,	cutoff=0)

FFU3	<-	factanal(x=data_FU,	factors=3,	rotation="promax")
print(FFU3,	cutoff=0)
```

```{r FU因子分析2}
fitFU1	<-	fa(r=data_FU,	nfactors=2,	rotate="varimax",	fm="ml")
print(fitFU1)

fitFU2	<-	fa(r=data_FU,	nfactors=2,	rotate="promax",	fm="ml")
print(fitFU2)
```
