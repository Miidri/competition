---
title: "因子分析 facter analysis"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT","gridExtra","fmsb","corrplot","graphics","GGally","psych", "GPArotation") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)

source("/home/miidri/competition/psql.R")
source("/home/miidri/competition/data_name.R")
```


# 因子分析 {.tabset .tabset-fade .tabset-pills}
***

## dataI_MM 既婚男性・情報セグメント 

### 相関行列
```{r dataI_MM1 相関行列}
#相関行列の作成
dataI_MM1.c <- cor(dataI_MM1[,-1])
#dataI_MM1.c

ggpairs(
	dataI_MM1[,-1],
	lower = list(continuous = "density", combo = "box")	)
```
  
### 固有値
```{r dataI_MM1 固有値}
eigenI_MM1 <- eigen(dataI_MM1.c)$values
# 固有値
eigenI_MM1
```

### 因子数決定
```{r dataI_MM1 plot}
# Minimum Average Partial, BIC
VSS(dataI_MM1[-1], n=10)
# 平行分析
fa.parallel(dataI_MM1[,-1])
```
  
MAP:2  
BIC:3  
PC:2  
FA:4  
MAPとPCが一致した.  
第2固有値までで行ってみる.

### 因子分析1
  
デフォルトであるminres(最小残差法)

```{r I_MM1 因子分析1}
# 回転なし
FI_MM1 <- factanal(x=dataI_MM1[,-1],	factors=2,	rotation="none")
print(FI_MM1,	cutoff=0)

par(mfrow=c(1,2)) 
barplot(FI_MM1$loadings[,1]) 
barplot(FI_MM1$loadings[,2]) 
plot(FI_MM1$loadings, type="n")
text(FI_MM1$loadings) 
```

```{r}
# varimax
FI_MM2	<-	factanal(x=dataI_MM1[,-1],	factors=2,	rotation="varimax")
print(FI_MM2,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_MM2$loadings[,1]) 
barplot(FI_MM2$loadings[,2]) 
plot(FI_MM2$loadings, type="n")
text(FI_MM2$loadings) 
```

```{r}
# promax
FI_MM3	<-	factanal(x=dataI_MM1[,-1],	factors=2,	rotation="promax")
print(FI_MM3,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_MM3$loadings[,1]) 
barplot(FI_MM3$loadings[,2]) 
plot(FI_MM3$loadings, type="n")
text(FI_MM3$loadings) 
```


### 因子分析2
  
今回はサンプルが多いので, 最尤法も行ってみた.

```{r I_MM1 因子分析2}
# none
mlI_MM1	<-	fa(r=dataI_MM1[,-1],	nfactors=2,	rotate="none",	fm="ml")
print(mlI_MM1)
par(mfrow=c(1,2)) 
barplot(mlI_MM1$loadings[,1]) 
barplot(mlI_MM1$loadings[,2]) 
plot(FI_MM1$loadings, type="n")
text(FI_MM1$loadings) 
```

```{r}
# varimax
mlI_MM2	<-	fa(r=dataI_MM1[,-1],	nfactors=2,	rotate="varimax",	fm="ml")
print(mlI_MM2)
par(mfrow=c(1,2)) 
barplot(mlI_MM2$loadings[,1]) 
barplot(mlI_MM2$loadings[,2]) 
plot(FI_MM2$loadings, type="n")
text(FI_MM2$loadings) 
```

```{r}
# promax
mlI_MM3	<-	fa(r=dataI_MM1[,-1],	nfactors=2,	rotate="promax",	fm="ml")
print(mlI_MM3)
par(mfrow=c(1,2)) 
barplot(mlI_MM3$loadings[,1]) 
barplot(mlI_MM3$loadings[,2]) 
plot(FI_MM3$loadings, type="n")
text(FI_MM3$loadings) 
```



## dataMU 未婚男性・情報セグメント 

### 相関行列
```{r dataI_MU1 相関行列}
#相関行列の作成
dataI_MU1.c <- cor(dataI_MU1[,-1])
#dataI_MU1.c
ggpairs(
	dataI_MU1[,-1],
	lower = list(continuous = "density", combo = "box")	)
```
  

### 固有値
```{r dataI_MU1 固有値}
eigenI_MU1 <- eigen(dataI_MU1.c)$values
# 固有値
eigenI_MU1
```

### 因子数決定
```{r dataI_MU1 plot}
# Minimum Average Partial, BIC
VSS(dataI_MU1[-1], n=10)
# 平行分析
fa.parallel(dataI_MU1[,-1])
```
  
MAP:1  
BIC:4  
PC:2  
FA:4  
なんでこんなバラバラなん！？
と思いつつ, 第2固有値までで行ってみる.

### 因子分析1
  
デフォルトであるminres(最小残差法)

```{r I_MU1 因子分析1}
# 回転なし
FI_MU1 <- factanal(x=dataI_MU1[,-1],	factors=2,	rotation="none")
print(FI_MU1,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_MU1$loadings[,1]) 
barplot(FI_MU1$loadings[,2]) 
plot(FI_MU1$loadings, type="n")
text(FI_MU1$loadings)
```

```{r}
# varimax
FI_MU2	<-	factanal(x=dataI_MU1[,-1],	factors=2,	rotation="varimax")
print(FI_MU2,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_MU2$loadings[,1]) 
barplot(FI_MU2$loadings[,2]) 
plot(FI_MU2$loadings, type="n")
text(FI_MU2$loadings) 
```

```{r}
# promax
FI_MU3	<-	factanal(x=dataI_MU1[,-1],	factors=2,	rotation="promax")
print(FI_MU3,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_MU3$loadings[,1]) 
barplot(FI_MU3$loadings[,2]) 
plot(FI_MU3$loadings, type="n")
text(FI_MU3$loadings) 
```

### 因子分析2
  
今回はサンプルが多いので, 最尤法も行ってみた.

```{r I_MU1 因子分析2}
# none
mlI_MU1	<-	fa(r=dataI_MU1[,-1],	nfactors=2,	rotate="none",	fm="ml")
print(mlI_MU1)
par(mfrow=c(1,2)) 
barplot(mlI_MU1$loadings[,1]) 
barplot(mlI_MU1$loadings[,2]) 
plot(FI_MU1$loadings, type="n")
text(FI_MU1$loadings) 
```

```{r}
# varimax
mlI_MU2	<-	fa(r=dataI_MU1[,-1],	nfactors=2,	rotate="varimax",	fm="ml")
print(mlI_MU2)
par(mfrow=c(1,2)) 
barplot(mlI_MU2$loadings[,1]) 
barplot(mlI_MU2$loadings[,2]) 
plot(FI_MU2$loadings, type="n")
text(FI_MU2$loadings) 
```

```{r}
# promax
mlI_MU3	<-	fa(r=dataI_MU1[,-1],	nfactors=2,	rotate="promax",	fm="ml")
print(mlI_MU3)
par(mfrow=c(1,2)) 
barplot(mlI_MU3$loadings[,1]) 
barplot(mlI_MU3$loadings[,2]) 
plot(FI_MU3$loadings, type="n")
text(FI_MU3$loadings) 
```


## dataFM 既婚女性・情報セグメント 

### 相関行列
```{r dataI_FM1 相関行列}
#相関行列の作成
dataI_FM1.c <- cor(dataI_FM1[,-1])
#dataI_FM1.c

ggpairs(
	dataI_FM1[,-1],
	lower = list(continuous = "density", combo = "box")	)
```
  
  
### 固有値
```{r dataI_FM1 固有値}
eigenI_FM1 <- eigen(dataI_FM1.c)$values
# 固有値
eigenI_FM1
```

### 因子数決定
```{r dataI_FM1 plot}
# Minimum Average Partial, BIC
VSS(dataI_FM1[-1], n=10)
# 平行分析
fa.parallel(dataI_FM1[,-1])
```
  
MAP:1  
BIC:4  
PC:2  
FA:4  
なんでこんなバラバラなん！？
と思いつつ, 第2固有値までで行ってみる.
### 因子分析1
  
デフォルトであるminres(最小残差法)

```{r I_FM1 因子分析1}
# 回転なし
FI_FM1 <- factanal(x=dataI_FM1[,-1],	factors=2,	rotation="none")
print(FI_FM1,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FM1$loadings[,1]) 
barplot(FI_FM1$loadings[,2]) 
plot(FI_FM1$loadings, type="n")
text(FI_FM1$loadings) 
```

```{r}
# varimax
FI_FM2	<-	factanal(x=dataI_FM1[,-1],	factors=2,	rotation="varimax")
print(FI_FM2,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FM2$loadings[,1]) 
barplot(FI_FM2$loadings[,2]) 
plot(FI_FM2$loadings, type="n")
text(FI_FM2$loadings)
```

```{r}
# promax
FI_FM3	<-	factanal(x=dataI_FM1[,-1],	factors=2,	rotation="promax")
print(FI_FM3,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FM3$loadings[,1]) 
barplot(FI_FM3$loadings[,2]) 
plot(FI_FM3$loadings, type="n")
text(FI_FM3$loadings) 
```

### 因子分析2
  
今回はサンプルが多いので, 最尤法も行ってみた.

```{r I_FM1 因子分析2}
# none
mlI_FM1	<-	fa(r=dataI_FM1[,-1],	nfactors=2,	rotate="none",	fm="ml")
print(mlI_FM1)
par(mfrow=c(1,2)) 
barplot(mlI_FM1$loadings[,1]) 
barplot(mlI_FM1$loadings[,2]) 
plot(FI_FM1$loadings, type="n")
text(FI_FM1$loadings) 
```

```{r}
# varimax
mlI_FM2	<-	fa(r=dataI_FM1[,-1],	nfactors=2,	rotate="varimax",	fm="ml")
print(mlI_FM2)
par(mfrow=c(1,2)) 
barplot(mlI_FM2$loadings[,1]) 
barplot(mlI_FM2$loadings[,2]) 
plot(FI_FM2$loadings, type="n")
text(FI_FM2$loadings)
```

```{r}
# promax
mlI_FM3	<-	fa(r=dataI_FM1[,-1],	nfactors=2,	rotate="promax",	fm="ml")
print(mlI_FM3)
par(mfrow=c(1,2)) 
barplot(mlI_FM3$loadings[,1]) 
barplot(mlI_FM3$loadings[,2]) 
plot(FI_FM3$loadings, type="n")
text(FI_FM3$loadings) 
```





## dataFU 未婚女性・情報セグメント 

### 相関行列
```{r dataI_FU1 相関行列}
#相関行列の作成
dataI_FU1.c <- cor(dataI_FU1[,-1])
#dataI_FU1.c
ggpairs(
	dataI_FU1[,-1],
	lower = list(continuous = "density", combo = "box")	)
```
  
  
### 固有値
```{r dataI_FU1 固有値}
eigenI_FU1 <- eigen(dataI_FU1.c)$values
# 固有値
eigenI_FU1
```

### 因子数決定
```{r dataI_FU1 plot}
# Minimum Average Partial, BIC
VSS(dataI_FU1[-1], n=10)
# 平行分析
fa.parallel(dataI_FU1[,-1])
```
MAP:1  
BIC:4  
PC:3  
FA:4  
なんでこんなバラバラなん！？
と思いつつ, 第3固有値までで行ってみる.

### 因子分析1
  
デフォルトであるminres(最小残差法)
```{r I_FU1 因子分析1}
# 回転なし
FI_FU1 <- factanal(x=dataI_FU1[,-1],	factors=3,	rotation="none")
print(FI_FU1,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FU1$loadings[,1]) 
barplot(FI_FU1$loadings[,2])
barplot(FI_FU1$loadings[,3]) 
plot(FI_FU1$loadings, type="n")
text(FI_FU1$loadings) 
```

```{r}
#varimax
FI_FU2	<-	factanal(x=dataI_FU1[,-1],	factors=3,	rotation="varimax")
print(FI_FU2,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FU2$loadings[,1]) 
barplot(FI_FU2$loadings[,2]) 
barplot(FI_FU2$loadings[,3]) 
plot(FI_MM2$loadings, type="n")
text(FI_MM2$loadings) 
```

```{r}
# promax
FI_FU3	<-	factanal(x=dataI_FU1[,-1],	factors=3,	rotation="promax")
print(FI_FU3,	cutoff=0)
par(mfrow=c(1,2)) 
barplot(FI_FU3$loadings[,1]) 
barplot(FI_FU3$loadings[,2]) 
barplot(FI_FU3$loadings[,3]) 
plot(FI_FU3$loadings, type="n")
text(FI_FU3$loadings) 
```

### 因子分析2
  
今回はサンプルが多いので, 最尤法も行ってみた.
```{r I_FU1 因子分析2}
# none
mlI_FU1	<-	fa(r=dataI_FU1[,-1],	nfactors=3,	rotate="none",	fm="ml")
print(mlI_FU1)
par(mfrow=c(1,2)) 
barplot(mlI_FU1$loadings[,1]) 
barplot(mlI_FU1$loadings[,2]) 
barplot(mlI_FU1$loadings[,3]) 
plot(FI_FU1$loadings, type="n")
text(FI_FU1$loadings)
```

```{r}
# varimax
mlI_FU2	<-	fa(r=dataI_FU1[,-1],	nfactors=3,	rotate="varimax",	fm="ml")
print(mlI_FU2)
par(mfrow=c(1,2)) 
barplot(mlI_FU2$loadings[,1]) 
barplot(mlI_FU2$loadings[,2]) 
barplot(mlI_FU2$loadings[,3]) 
plot(FI_FU2$loadings, type="n")
text(FI_FU2$loadings) 
```

```{r}
# promax
mlI_FU3	<-	fa(r=dataI_FU1[,-1],	nfactors=3,	rotate="promax",	fm="ml")
print(mlI_FU3)
par(mfrow=c(1,2)) 
barplot(mlI_FU3$loadings[,1]) 
barplot(mlI_FU3$loadings[,2]) 
barplot(mlI_FU3$loadings[,3]) 
plot(FI_FU3$loadings, type="n")
text(FI_FU3$loadings) 
```




