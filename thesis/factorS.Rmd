---
title: "factorS"
author: "Midori Omura"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone 
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
title: "因子分析 facter analysis"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: sandstone
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```


```{r set_up}
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('knitr','DBI','RPostgreSQL','tidyverse',"reshape2","lubridate","dbplot","DT","gridExtra","fmsb","corrplot","graphics","GGally","psych", "GPArotation","proxy","DistatisR", "rgl","scatterplot3d") 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)

source("/home/miidri/competition/psql.R")
source("/home/miidri/competition/data_name.R")
```


# 購買セグメント 
***
- S1 どうしても必要なもの以外、買わないほうだ
- S2 丈夫で長持ちするモノを選ぶことが多い
- S3 流行に左右されない、長年使い続けられるものを選ぶことが多い
- S4 周りの人が持っているモノなどを見て思わず自分も欲しくなってしまうことが多い
- S5 周りのみんなが持っているモノを自分だけ持っていないと不安に感じる
- S6 周りの人がみんな買っているならその商品は間違いなく良いモノだと思う
- S7 買い物をすること自体が楽しく、好きだ
- S8 「限定モノ」や「流行モノ」に弱く、すぐ欲しくなる
- S9 一流・有名ブランド、メーカーの商品を買うのが好きだ（衣料品、バッグ、時計など）

# dataS
***

```{r}
dataS1 <- cbind(dataS1, index)
dataS1 <- dataS1[c(1,11,2,3,4,5,6,7,8,9,10)]
head(dataS1) %>% 
  kable()
```

## 相関行列
```{r dataS1 相関行列}
#相関行列の作成
dataS.c <- cor(dataS1[,-1:-2])

dataS.c %>% 
  kable()
```
  
## 固有値
```{r dataS1 固有値}
eigenS1 <- eigen(dataS.c)$values
# 固有値
eigenS1
```

## 因子数決定
```{r dataS1 plot}
# Minimum Average Partial, BIC
VSS(dataS1[,-1:-2], n=10)
# 平行分析
fa.parallel(dataS1[,-1:-2], main = "購買特性")
```  
- MAP:2  
- BIC:4  
- PC:3  
- FA:3  
第3固有値までで行ってみる.

# 因子分析
***  
データ数が多いため, 最尤法を用いる.  
また心理尺度であるため, 斜交回転 (promax)を行う.  

```{r promax}
mlS	<-	fa(r=dataS1[,-1:-2],	nfactors=3,	rotate="promax",	fm="ml")
print(mlS)
#par(mfrow=c(1,3)) 
#barplot(mlS$loadings[,1], main="ML1") 
#barplot(mlS$loadings[,2], main="ML2") 
#barplot(mlS$loadings[,3], main="ML3") 
#plot(mlS$loadings, type="n")
#text(mlS$loadings) 

loadingsS <- mlS$loadings[,1:3]
loadingsS <- 
  data.frame(
    question_num = c("S1","S2","S3","S4","S5","S6","S7","S8","S9"),
    loadingsS)

load1 <- ggplot(loadingsS, aes(x = question_num, y = ML1)) +
  geom_bar(stat = "identity", position = "identity") +
  scale_fill_brewer(type ="seq",palette = 1)+ theme_bw()
load2 <- ggplot(loadingsS, aes(x = question_num, y = ML2)) +
  geom_bar(stat = "identity", position = "identity") +
  scale_fill_brewer(type ="seq",palette = 1)+ theme_bw()
load3 <- ggplot(loadingsS, aes(x = question_num, y = ML3)) +
  geom_bar(stat = "identity", position = "identity") +
  scale_fill_brewer(type ="seq",palette = 1)+ theme_bw()
loadT1 <- ggplot(loadingsS, aes(x = ML1, y = ML2, label = question_num)) +
  geom_point() +theme_bw()+ geom_label(position = "nudge" )
loadT2 <- ggplot(loadingsS, aes(x = ML1, y = ML3, label = question_num)) +
  geom_point() +theme_bw()+ geom_label(position = "nudge" )
loadT3 <- ggplot(loadingsS, aes(x = ML2, y = ML3, label = question_num)) +
  geom_point() +theme_bw()+ geom_label(position = "nudge" ) 
grid.arrange(load1, load2, load3,
             ncol = 2)
grid.arrange(loadT1, loadT2, loadT3,
             ncol = 2)
```

## biplot
```{r biplot}
par(mfrow=c(1,3)) 

biplot(mlS$scores[,c(1,2)], mlS$loadings)
biplot(mlS$scores[,c(1,3)], mlS$loadings)
biplot(mlS$scores[,c(2,3)], mlS$loadings)
pairs(mlS$scores)


scoresS <- mlS$scores[,1:3]
scoresS <- data.frame(scoresS)
rownames(scoresS) <- dataS$house_num
scoresS <- cbind(scoresS, data2$index, data2$genreIS)
colnames(scoresS) <- c("ML1","ML2","ML3","index","genreIS")

# colored by sex and marriage
S12 <- ggplot(scoresS, aes(x=ML1, y=ML2, col=index)) +
  geom_point(size = 1)+
  scale_color_manual(values = c( "#ff0000","#0000ff","#ff99cc","#00cbcb"))+theme_bw()
S13 <- ggplot(scoresS, aes(x=ML1, y=ML3, col=index)) +
  geom_point(size = 1)+
  scale_color_manual(values = c( "#ff0000","#0000ff","#ff99cc","#00cbcb"))+theme_bw()
S23 <- ggplot(scoresS, aes(x=ML2, y=ML3, col=index)) +
  geom_point(size = 1)+
  scale_color_manual(values = c( "#ff0000","#0000ff","#ff99cc","#00cbcb"))+theme_bw()

grid.arrange(S12, S13, S23,
             ncol = 2)
```

## ラベル付け
```{r}
# colored by IS segmemnt
SS12 <-ggplot(scoresS, aes(x=ML1, y=ML2, col=genreIS)) +
  geom_point(size = 1)+theme_bw()
SS13 <-ggplot(scoresS, aes(x=ML1, y=ML3, col=genreIS)) +
  geom_point(size = 1)+theme_bw()
SS23 <-ggplot(scoresS, aes(x=ML2, y=ML3, col=genreIS)) +
  geom_point(size = 1)+theme_bw()

grid.arrange(SS12, SS13, SS23,
             ncol = 2)
```

## 基本属性
```{r ML1ML2 indexで分解}
scoresS_MM<-
  scoresS%>% 
   filter(index == "既婚男性")
scoresS_MU<-
  scoresS%>% 
   filter(index == "未婚男性")
scoresS_FM<-
  scoresS%>% 
   filter(index == "既婚女性")
scoresS_FU<-
  scoresS%>% 
   filter(index == "未婚女性")

scoresS_MMp <- ggplot(scoresS_MM, aes(x=ML1, y=ML2)) +
  geom_point(size = 1, color = "#0000ff")+ ggtitle("既婚男性")+theme_bw()
scoresS_MUp <- ggplot(scoresS_MU, aes(x=ML1, y=ML2)) +
  geom_point(size = 1, color = "#00cbcb")+ ggtitle("未婚男性")+theme_bw()
scoresS_FMp <- ggplot(scoresS_FM, aes(x=ML1, y=ML2)) +
  geom_point(size = 1, color = "#ff0000")+ ggtitle("既婚女性")+theme_bw()
scoresS_FUp <- ggplot(scoresS_FU, aes(x=ML1, y=ML2)) +
  geom_point(size = 1, color = "#ff99cc")+ ggtitle("未婚女性")+theme_bw()

grid.arrange(scoresS_MMp, scoresS_MUp, scoresS_FMp, scoresS_FUp,
             ncol = 2)
```

```{r}

scores <- mlS$scores
fa1 <- scores[,1]
fa2 <- scores[,2]
fa3 <- scores[,3]

# Loadings
loads <- mlS$loadings

# Scale factor for loadings
scale.loads <- 9

# 3D plot
library(plotly)
p <- plot_ly() %>%
  add_trace(x=fa1, y=fa2, z=fa3, name="", color= index,
            type="scatter3d", mode="markers",
            marker = list(#color=y,
              size = 1,
               # colorscale = c("#FFE1A1", "#683531"), 
               opacity = 0.7)) 

for (k in 1:nrow(loads)) {
   fa1 <- c(0, loads[k,1])*scale.loads
   fa2 <- c(0, loads[k,2])*scale.loads
   fa3 <- c(0, loads[k,3])*scale.loads
   p <- p %>% add_trace(x=fa1, y=fa2, z=fa3,
                        name = rownames(loads)[k],
            type="scatter3d", mode="lines",
            line = list(width=8),
            opacity = 1)
}
print(p)
```


# 距離行列
```{r dist}
dES <- proxy::dist(mlS$scores, method="Euclidean")
head(dES,5)
dES1 <- as.matrix(dES)
#write.csv(dES1, file= "/home/miidri/competition/dEI1.csv")
rownames(dES1) <- dataS$house_num
colnames(dES1) <- dataS$house_num
dES1[1:5,1:5]
```